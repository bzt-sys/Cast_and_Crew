
flowchart TB
  %% =============== INPUTS ===============
  subgraph Inputs
    BRIEF[[Project Brief\n(year, budget, genres, bill_order)]]
    DATA[(fa long table)]
  end

  %% =============== TRAINING ===============
  subgraph Training Pipeline
    A1[Leakage-safe labels\nTop quartile resonance\ncomputed on TRAIN years only]
    A2[Feature engineering\natr3, dtr3, release_density,\ngenre_*_aff, year_sin/cos,\nBUDGET_BIN_EDGES, bfd]
    A3[Temporal split\nby TRAIN_CUTOFF_YEAR]
    A4[Actor head model\n(HGB/RF)]
    A5[Director head model\n(HGB)]
    A6[Calibration fit\nPlatt on FEATURES (prefit),\nIsotonic on base probs]
    A7[Cycle head fit\nResidual r = y - p_base\n~ year_sin/cos]
  end

  %% =============== SERVING ===============
  subgraph Serving (Recommender)
    S1[Build candidate matrix (as-of year)\nactor means (stable_feats),\ntrailing aggregates, film features\n— enforce feature contract]
    S2[Score base probs (p_base)\nusing use_model]
    S3[Cycle blend to ranking score\np_rank = blend(p_base, uplift)]
    S4[Calibrated probs for display only\np_cal = isotonic(p_base) or Platt(X)]
    S5[Unsung alternates\nkNN on actor_feat (cosine)]
    S6[Reason codes\nperturb features → Δprob]
    S7[Optional synergy\nadjust actor p via chosen director]
  end

  %% =============== OUTPUTS ===============
  subgraph Outputs
    O1[[Actor slate CSV\nTop-N with p_high, p_base, p_cal]]
    O2[[Alternates CSV]]
    O3[[Reason-codes CSV + plots]]
    O4[[Manifest JSON\n(params, timestamps, flags)]]
  end

  %% Connections
  BRIEF --> S1
  DATA --> A1 --> A2 --> A3 --> A4
  A3 --> A5
  A3 --> A6
  A3 --> A7
  DATA --> S1
  A4 --> S2
  A7 --> S3
  S2 --> S3 --> S4
  S2 --> S5
  S2 --> S6
  S3 --> O1
  S5 --> O2
  S6 --> O3
  S4 --> O1
  S7 --> O1
  A5 --> S7
